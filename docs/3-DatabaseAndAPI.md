# ZeroAge Database and API Specifications

## Table of Contents
1. [Database Schema](#database-schema)
2. [TypeScript Types](#typescript-types)
3. [API Specifications](#api-specifications)
4. [Data Flow Examples](#data-flow-examples)

## Database Schema

### Profiles Table
```sql
CREATE TABLE profiles (
  user_id UUID REFERENCES auth.users(id) PRIMARY KEY,
  name TEXT NOT NULL,
  weight NUMERIC CHECK (weight > 0),
  height NUMERIC CHECK (height > 0),
  body_fat NUMERIC CHECK (body_fat >= 0),
  date_of_birth DATE,
  gender TEXT,
  unit TEXT CHECK (unit IN ('kg', 'lbs')) NOT NULL DEFAULT 'kg',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Sample Data
INSERT INTO profiles (user_id, name, weight, height, body_fat, unit) VALUES
('123e4567-e89b-12d3-a456-426614174000', 'John Doe', 75.5, 180, 15, 'kg');
```

### Exercises Table
```sql
CREATE TABLE exercises (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  primary_muscle TEXT NOT NULL,
  secondary_muscles TEXT[] NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Sample Data
INSERT INTO exercises (name, primary_muscle, secondary_muscles) VALUES
('Bench Press', 'chest', ARRAY['triceps', 'shoulders']),
('Squat', 'quadriceps', ARRAY['glutes', 'hamstrings']),
('Deadlift', 'back', ARRAY['glutes', 'hamstrings']);
```

### Workouts Table
```sql
CREATE TABLE workouts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  date DATE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  -- Index for quick access to user's workouts and date filtering
  CONSTRAINT unique_user_workout UNIQUE (user_id, date, created_at)
);

-- Sample Data
INSERT INTO workouts (user_id, date) VALUES
('123e4567-e89b-12d3-a456-426614174000', '2025-02-04');
```

### Workout Sets Table
```sql
CREATE TABLE workout_sets (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  workout_id BIGINT REFERENCES workouts(id) ON DELETE CASCADE,
  exercise_id BIGINT REFERENCES exercises(id),
  set_number INTEGER NOT NULL,
  reps INTEGER NOT NULL CHECK (reps > 0),
  weight NUMERIC(5,2) NOT NULL CHECK (weight >= 0),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  -- Index for quick access to all sets in a workout
  CONSTRAINT unique_set_in_workout UNIQUE (workout_id, exercise_id, set_number)
);

-- Sample Data
INSERT INTO workout_sets (workout_id, exercise_id, set_number, reps, weight) VALUES
(1, 1, 1, 10, 60.00),
(1, 1, 2, 8, 65.00),
(1, 2, 1, 12, 100.00);
```

### Performance Optimizations

#### 1. Materialized Views

We use materialized views to pre-compute expensive aggregations and ensure O(1) lookup times for commonly accessed data:

##### workout_history
```sql
CREATE MATERIALIZED VIEW workout_history AS
SELECT 
    w.id,
    w.user_id,
    w.date,
    w.created_at,
    COUNT(DISTINCT ws.exercise_id) as exercise_count,
    COUNT(*) as total_sets,
    SUM(ws.reps * ws.weight) as total_volume
FROM workouts w
JOIN workout_sets ws ON w.id = ws.workout_id
GROUP BY w.id, w.user_id, w.date, w.created_at;
```
- **Purpose**: Fast retrieval of workout history with pre-computed metrics
- **Performance Impact**: Reduces complex JOIN and aggregation queries from O(n) to O(1)
- **Use Case**: Workout history list and calendar views

##### user_stats
```sql
CREATE MATERIALIZED VIEW user_stats AS
SELECT 
    w.user_id,
    COUNT(DISTINCT w.id) as total_workouts,
    SUM(ws.reps * ws.weight) as total_volume,
    MAX(CASE WHEN date - LAG(date, 1) OVER w = 1 THEN 1 ELSE 0 END) 
        OVER (PARTITION BY user_id) as current_streak,
    MAX(streak_length) as best_streak
FROM workouts w
JOIN workout_sets ws ON w.id = ws.workout_id
WINDOW w AS (PARTITION BY user_id ORDER BY date);
```
- **Purpose**: Quick access to user statistics and achievements
- **Performance Impact**: Reduces complex window functions and aggregations from O(n log n) to O(1)
- **Use Case**: Dashboard statistics and achievements

##### volume_stats
```sql
CREATE MATERIALIZED VIEW volume_stats AS
WITH daily AS (
    SELECT user_id, date, SUM(reps * weight) as volume
    FROM workouts w
    JOIN workout_sets ws ON w.id = ws.workout_id
    GROUP BY user_id, date
)
SELECT 
    d.user_id,
    d.date,
    d.volume as daily_volume,
    w.volume as weekly_volume,
    m.volume as monthly_volume
FROM daily d
JOIN weekly w ON d.user_id = w.user_id 
JOIN monthly m ON d.user_id = m.user_id;
```
- **Purpose**: Pre-computed volume statistics at different time granularities
- **Performance Impact**: Reduces multiple table scans and temporal calculations from O(nÂ²) to O(1)
- **Use Case**: Progress charts and volume tracking

#### 2. Indexes

Strategic indexes for optimal query performance:

```sql
CREATE INDEX idx_workouts_user_date ON workouts(user_id, date);
CREATE INDEX idx_workout_sets_workout ON workout_sets(workout_id);
CREATE INDEX idx_workouts_user_date_exists ON workouts(user_id, date) 
WHERE EXISTS (SELECT 1 FROM workout_sets WHERE workout_id = workouts.id);
```

- **Purpose**: Optimize common query patterns
- **Performance Impact**: Reduces table scans from O(n) to O(log n)
- **Use Cases**: 
  - Fast workout lookup by date
  - Efficient set retrieval
  - Quick calendar date highlighting

#### 3. Auto-refresh Mechanism

Materialized views are automatically refreshed when data changes:

```sql
CREATE TRIGGER refresh_stats_trigger
AFTER INSERT OR UPDATE OR DELETE ON workout_sets
FOR EACH STATEMENT
EXECUTE FUNCTION refresh_stats();
```

- **Purpose**: Keep pre-computed data fresh
- **Performance Impact**: Minimal overhead during writes, ensures reads are always O(1)
- **Note**: Uses concurrent refresh to avoid blocking reads

## TypeScript Types

```typescript
// src/types/profile.ts
export interface Profile {
  user_id: string;
  name: string;
  weight?: number;
  height?: number;
  body_fat?: number;
  date_of_birth?: string;
  gender?: string;
  unit: 'kg' | 'lbs';
  created_at?: string;
  updated_at?: string;
}

// src/types/exercise.ts
export interface Exercise {
  id: number;
  name: string;
  primary_muscle: string;
  secondary_muscles: string[];
  created_at?: string;
  updated_at?: string;
}

// src/types/workout.ts
export interface Set {
  reps: number;
  weight: number;
}

export interface ExerciseWithSets {
  exercise_id: number;
  sets: Set[];
}

export interface CreateWorkoutRequest {
  date: string;
  exercises: ExerciseWithSets[];
}

export interface WorkoutSet {
  set_number: number;
  reps: number;
  weight: number;
}

export interface WorkoutExercise {
  exercise: Exercise;
  sets: WorkoutSet[];
}

export interface Workout {
  id: number;
  date: string;
  created_at: string;
  exercises: WorkoutExercise[];
}
```

## API Specifications

### Profile APIs

#### Get Profile
```typescript
// GET /api/profile
// Response: Profile
{
  "name": "John Doe",
  "weight": 75.5,
  "height": 180,
  "body_fat": 15,
  "date_of_birth": "1990-01-01",
  "gender": "male",
  "unit": "kg",
  "created_at": "2025-02-04T13:03:53Z",
  "updated_at": "2025-02-04T13:03:53Z"
}
```

#### Update Profile
```typescript
// PUT /api/profile
// Request: Partial<Profile>
{
  "weight": 76.2,
  "height": 180,
  "body_fat": 14.5,
  "unit": "kg"
}

// Response: Profile
// Same as GET /api/profile
```

### Exercise APIs

#### Get Exercises
```typescript
// GET /api/exercises
// Response: Exercise[]
[
  {
    "id": 1,
    "name": "Bench Press",
    "primary_muscle": "chest",
    "secondary_muscles": ["triceps", "shoulders"]
  }
]
```

### Workout APIs

#### Create Workout
```typescript
// POST /api/workout
// Request: CreateWorkoutRequest
{
  "date": "2025-02-04",
  "exercises": [
    {
      "exercise_id": 1,
      "sets": [
        { "reps": 10, "weight": 60 },
        { "reps": 8, "weight": 65 }
      ]
    }
  ]
}

// Response: { id: number }
{
  "id": 1
}
```

#### Get Workouts by Date
```typescript
// GET /api/workouts?date=2025-02-04
// Response: Workout[]
[
  {
    "id": 1,
    "date": "2025-02-04",
    "created_at": "2025-02-04T09:00:00Z",
    "exercises": [
      {
        "exercise": {
          "id": 1,
          "name": "Bench Press",
          "primary_muscle": "chest",
          "secondary_muscles": ["triceps", "shoulders"]
        },
        "sets": [
          { "set_number": 1, "reps": 10, "weight": 60 },
          { "set_number": 2, "reps": 8, "weight": 65 }
        ]
      }
    ]
  }
]
```

#### Get Single Workout
```typescript
// GET /api/workout/:id
// Response: Workout
// Same structure as single workout in GET /api/workouts
```

#### Get Workout Dates
```typescript
// GET /api/workouts/dates
// Response: { dates: string[], total_workouts: number }
{
  "dates": ["2025-02-04", "2025-02-03", "2025-02-01"],
  "total_workouts": 3
}
```

### Statistics and Analytics

#### Get User Statistics
```typescript
// GET /api/stats
// Response: { total_workouts: number, total_volume: number, current_streak: number, best_streak: number }
{
  "total_workouts": 10,
  "total_volume": 1000,
  "current_streak": 5,
  "best_streak": 10
}
```

#### Get Daily Volume Statistics
```typescript
// GET /api/stats/volume?start_date=2025-02-01&end_date=2025-02-28
// Response: Array of daily stats with weekly and monthly context
[
  {
    "date": "2025-02-01",
    "daily_volume": 100,    // Total volume for this specific day
    "weekly_volume": 500,   // Total volume for the week containing this day
    "monthly_volume": 2000  // Total volume for the month containing this day
  }
]
```

#### Get Aggregated Volume Statistics
```typescript
// GET /api/stats/volume/aggregated?start_date=2025-01-01&end_date=2025-06-30&group_by=week
// group_by can be 'week' or 'month'
// Response for group_by=week:
[
  {
    "period": "2025-W01",     // ISO week format: YYYY-Www
    "volume": 32000,          // Total volume for this week
    "start_date": "2025-01-01" // First day of the week
  },
  {
    "period": "2025-W02",
    "volume": 35000,
    "start_date": "2025-01-08"
  }
]

// Response for group_by=month:
[
  {
    "period": "2025-01",      // YYYY-MM format
    "volume": 150000,         // Total volume for this month
    "start_date": "2025-01-01" // First day of the month
  },
  {
    "period": "2025-02",
    "volume": 140000,
    "start_date": "2025-02-01"
  }
]
```

Example Usage:
```typescript
// Get weekly totals for Q1 2025
const response = await fetch('/api/stats/volume/aggregated?start_date=2025-01-01&end_date=2025-03-31&group_by=week');
const weeklyVolumes = await response.json();
// Returns array of weekly volumes, each with period identifier and start date

// Get monthly totals for first half of 2025
const response = await fetch('/api/stats/volume/aggregated?start_date=2025-01-01&end_date=2025-06-30&group_by=month');
const monthlyVolumes = await response.json();
// Returns array of monthly volumes, each with period identifier and start date
```

## Data Flow Examples

### Creating a New Workout

1. **Frontend State (WorkoutLogger Component)**
```typescript
const [exercises, setExercises] = useState<ExerciseWithSets[]>([]);

// When user adds sets
const handleAddSet = (exerciseId: number) => {
  setExercises(prev => prev.map(ex => 
    ex.exercise_id === exerciseId
      ? { ...ex, sets: [...ex.sets, { reps: 0, weight: 0 }] }
      : ex
  ));
};
```

2. **API Call**
```typescript
const saveWorkout = async () => {
  const response = await fetch('/api/workout', {
    method: 'POST',
    body: JSON.stringify({
      date: format(new Date(), 'yyyy-MM-dd'),
      exercises
    })
  });
  const { id } = await response.json();
};
```

3. **Database Operations**
```sql
-- 1. Create workout
INSERT INTO workouts (user_id, date)
VALUES ($1, $2)
RETURNING id;

-- 2. Create workout sets
INSERT INTO workout_sets (workout_id, exercise_id, set_number, reps, weight)
VALUES ($1, $2, $3, $4, $5);
```

### Viewing Workout History

1. **Database Query**
```sql
SELECT 
    w.id,
    w.date,
    w.created_at,
    json_agg(
        json_build_object(
            'exercise', json_build_object(
                'id', e.id,
                'name', e.name,
                'primary_muscle', e.primary_muscle,
                'secondary_muscles', e.secondary_muscles
            ),
            'sets', json_agg(
                json_build_object(
                    'set_number', ws.set_number,
                    'reps', ws.reps,
                    'weight', ws.weight
                ) ORDER BY ws.set_number
            )
        )
    ) as exercises
FROM workouts w
JOIN workout_sets ws ON w.id = ws.workout_id
JOIN exercises e ON ws.exercise_id = e.id
WHERE w.user_id = $1 AND w.date = $2
GROUP BY w.id, w.date, w.created_at
ORDER BY w.created_at;
```

2. **API Response**
```typescript
// GET /api/workouts?date=2025-02-04
// Maps directly to Workout[] type
```

3. **Frontend Display (WorkoutHistory Component)**
```typescript
const [workouts, setWorkouts] = useState<Workout[]>([]);

useEffect(() => {
  const fetchWorkouts = async () => {
    const response = await fetch(`/api/workouts?date=${selectedDate}`);
    const data = await response.json();
    setWorkouts(data);
  };
  fetchWorkouts();
}, [selectedDate]);
```

### Performance Characteristics

#### Write Operations
1. **Creating a Workout**: O(1)
   - Indexed inserts into workouts and workout_sets tables
   - Async materialized view refresh

2. **Updating Profile**: O(1)
   - Single row update with primary key

#### Read Operations
1. **Workout History**: O(1)
   - Pre-computed in workout_history materialized view

2. **Dashboard Stats**: O(1)
   - Pre-computed in user_stats materialized view

3. **Volume Analytics**: O(1)
   - Pre-computed in volume_stats materialized view

4. **Calendar View**: O(log n)
   - Uses partial index for date existence check

#### Data Consistency
- Materialized views are refreshed automatically after each workout modification
- Concurrent refresh ensures reads are never blocked
- Strong consistency for direct table access
- Eventually consistent (typically < 1s) for materialized views
